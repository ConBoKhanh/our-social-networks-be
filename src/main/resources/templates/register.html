<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>conbokhanh • Đăng ký</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #000;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container { max-width: 400px; width: 100%; }
        .box {
            background: #000;
            border: 1px solid #363636;
            border-radius: 4px;
            padding: 40px;
            margin-bottom: 12px;
        }
        .logo { text-align: center; margin-bottom: 20px; }
        .logo h1 { font-family: 'Billabong', cursive; font-size: 48px; color: #f5f5f5; }
        .subtitle { text-align: center; color: #a8a8a8; font-size: 16px; margin-bottom: 24px; }
        .form-group { margin-bottom: 12px; position: relative; }
        .form-group label { display: block; color: #c7c7c7; font-size: 12px; font-weight: 600; margin-bottom: 6px; }
        .form-group input {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #363636;
            border-radius: 6px;
            background: #121212;
            font-size: 14px;
            color: #f5f5f5;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-group input:focus { border-color: #c7c7c7; }
        .form-group input::placeholder { color: #a8a8a8; }
        .eye-btn {
            position: absolute;
            right: 12px;
            top: 38px;
            background: none;
            border: none;
            cursor: pointer;
            color: #a8a8a8;
            padding: 4px;
        }
        .btn {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 16px;
        }
        .btn-primary { background: #0095f6; color: #fff; }
        .btn-primary:hover:not(:disabled) { background: #1877f2; }
        .btn-primary:disabled { background: #0095f6; opacity: 0.4; cursor: not-allowed; }
        .btn.loading { position: relative; color: transparent !important; }
        .btn.loading::after {
            content: '';
            position: absolute;
            width: 18px; height: 18px;
            top: 50%; left: 50%;
            margin: -9px 0 0 -9px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .step { display: none; }
        .step.active { display: block; }
        .otp-inputs { display: flex; gap: 8px; justify-content: center; margin: 20px 0; }
        .otp-inputs input {
            width: 48px; height: 56px;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            border: 2px solid #363636;
            border-radius: 8px;
            background: #121212;
            color: #f5f5f5;
            outline: none;
        }
        .otp-inputs input:focus { border-color: #0095f6; }
        .resend-link { text-align: center; margin-top: 16px; }
        .resend-link a { color: #0095f6; text-decoration: none; font-size: 14px; cursor: pointer; }
        .resend-link a:hover { text-decoration: underline; }
        .resend-link a.disabled { color: #a8a8a8; pointer-events: none; }
        .back-link { text-align: center; margin-top: 20px; }
        .back-link a { color: #f0f0f0; text-decoration: none; font-size: 14px; }
        .signup-box {
            background: #000;
            border: 1px solid #363636;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
        }
        .signup-box span { color: #f0f0f0; font-size: 14px; }
        .signup-box a { color: #0095f6; font-weight: 600; text-decoration: none; }
        .strength-bar { display: flex; gap: 4px; margin: 8px 0; }
        .strength-bar div { flex: 1; height: 3px; background: #363636; border-radius: 2px; transition: all 0.3s; }
        .strength-text { font-size: 12px; color: #a8a8a8; }
        .requirements { font-size: 11px; color: #8e8e8e; margin-top: 6px; line-height: 1.6; }
        .requirements div.met { color: #00d26a; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; max-width: 340px; }
        .toast {
            background: #262626; color: #f5f5f5; padding: 14px 18px; border-radius: 8px;
            margin-bottom: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            transform: translateX(400px); opacity: 0; transition: all 0.3s ease;
            display: flex; align-items: center; gap: 10px; font-size: 14px;
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.success { border-left: 4px solid #00d26a; }
        .toast.error { border-left: 4px solid #ed4956; }
        .toast.info { border-left: 4px solid #0095f6; }
        .toast-close { background: none; border: none; color: #a8a8a8; cursor: pointer; font-size: 18px; margin-left: auto; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Billabong&display=swap" rel="stylesheet">
</head>
<body>
<div class="container">
    <div class="box">
        <div class="logo"><h1>conbokhanh</h1></div>
        <p class="subtitle">Đăng ký để xem ảnh và video từ bạn bè.</p>

        <!-- Step 1: Enter Email -->
        <div id="step1" class="step active">
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="email" placeholder="Nhập email của bạn" required>
            </div>
            <button type="button" class="btn btn-primary" id="sendOtpBtn" onclick="sendOtp()">Tiếp tục</button>
        </div>

        <!-- Step 2: Enter OTP -->
        <div id="step2" class="step">
            <p style="color: #f0f0f0; text-align: center; margin-bottom: 8px;">Nhập mã OTP đã gửi đến</p>
            <p style="color: #0095f6; text-align: center; margin-bottom: 20px;" id="emailDisplay"></p>
            <div class="otp-inputs">
                <input type="text" maxlength="1" id="otp1" oninput="moveToNext(this, 'otp2')" onkeydown="handleBackspace(event, 'otp1', null)">
                <input type="text" maxlength="1" id="otp2" oninput="moveToNext(this, 'otp3')" onkeydown="handleBackspace(event, 'otp2', 'otp1')">
                <input type="text" maxlength="1" id="otp3" oninput="moveToNext(this, 'otp4')" onkeydown="handleBackspace(event, 'otp3', 'otp2')">
                <input type="text" maxlength="1" id="otp4" oninput="moveToNext(this, 'otp5')" onkeydown="handleBackspace(event, 'otp4', 'otp3')">
                <input type="text" maxlength="1" id="otp5" oninput="moveToNext(this, 'otp6')" onkeydown="handleBackspace(event, 'otp5', 'otp4')">
                <input type="text" maxlength="1" id="otp6" oninput="verifyOtpAuto()" onkeydown="handleBackspace(event, 'otp6', 'otp5')">
            </div>
            <button type="button" class="btn btn-primary" id="verifyOtpBtn" onclick="verifyOtp()">Xác nhận</button>
            <div class="resend-link">
                <a id="resendLink" onclick="resendOtp()">Gửi lại mã (<span id="countdown">60</span>s)</a>
            </div>
        </div>

        <!-- Step 3: Create Password -->
        <div id="step3" class="step">
            <div class="form-group">
                <label>Tên người dùng (tùy chọn)</label>
                <input type="text" id="username" placeholder="Để trống sẽ tự động tạo">
            </div>
            <div class="form-group">
                <label>Mật khẩu</label>
                <input type="password" id="password" placeholder="Tối thiểu 8 ký tự" oninput="checkStrength()" style="padding-right: 45px;">
                <button type="button" class="eye-btn" onclick="togglePassword('password')">
                    <svg id="password-eye" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
            </div>
            <div id="strengthSection" style="display: none;">
                <div class="strength-bar">
                    <div id="bar1"></div><div id="bar2"></div><div id="bar3"></div><div id="bar4"></div>
                </div>
                <div class="strength-text" id="strengthText"></div>
                <div class="requirements">
                    <div id="reqLen">✗ Ít nhất 8 ký tự</div>
                    <div id="reqUpper">✗ Có chữ hoa (A-Z)</div>
                    <div id="reqLower">✗ Có chữ thường (a-z)</div>
                    <div id="reqNum">✗ Có số (0-9)</div>
                    <div id="reqSpec">✗ Có ký tự đặc biệt</div>
                </div>
            </div>
            <div class="form-group">
                <label>Xác nhận mật khẩu</label>
                <input type="password" id="confirmPassword" placeholder="Nhập lại mật khẩu" style="padding-right: 45px;">
                <button type="button" class="eye-btn" onclick="togglePassword('confirmPassword')">
                    <svg id="confirmPassword-eye" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                    </svg>
                </button>
            </div>
            <button type="button" class="btn btn-primary" id="registerBtn" onclick="completeRegistration()">Đăng ký</button>
        </div>

        <div class="back-link"><a href="/login">← Quay lại đăng nhập</a></div>
    </div>
    <div class="signup-box">
        <span>Đã có tài khoản? </span><a href="/login">Đăng nhập</a>
    </div>
</div>

<script>
let currentEmail = '';
let currentOtp = '';
let countdownInterval;

function showStep(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step' + step).classList.add('active');
}

async function sendOtp() {
    const email = document.getElementById('email').value.trim();
    if (!email || !email.includes('@')) {
        showToast('Vui lòng nhập email hợp lệ!', 'error');
        return;
    }
    
    const btn = document.getElementById('sendOtpBtn');
    btn.disabled = true;
    btn.classList.add('loading');
    
    try {
        const res = await fetch('/auth/register/send-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email })
        });
        const data = await res.json();
        
        if (res.ok && data.success) {
            currentEmail = email;
            document.getElementById('emailDisplay').textContent = email;
            showStep(2);
            startCountdown();
            showToast('Mã OTP đã được gửi đến email của bạn!', 'success');
            document.getElementById('otp1').focus();
        } else {
            showToast(data.error || 'Không thể gửi OTP', 'error');
        }
    } catch (e) {
        showToast('Lỗi kết nối', 'error');
    } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
    }
}

function moveToNext(current, nextId) {
    if (current.value.length === 1 && nextId) {
        document.getElementById(nextId).focus();
    }
}

function handleBackspace(e, currentId, prevId) {
    if (e.key === 'Backspace' && !document.getElementById(currentId).value && prevId) {
        document.getElementById(prevId).focus();
    }
}

function getOtpValue() {
    return ['otp1','otp2','otp3','otp4','otp5','otp6'].map(id => document.getElementById(id).value).join('');
}

function verifyOtpAuto() {
    const otp = getOtpValue();
    if (otp.length === 6) verifyOtp();
}

async function verifyOtp() {
    const otp = getOtpValue();
    if (otp.length !== 6) {
        showToast('Vui lòng nhập đủ 6 số!', 'error');
        return;
    }
    
    const btn = document.getElementById('verifyOtpBtn');
    btn.disabled = true;
    btn.classList.add('loading');
    
    try {
        const res = await fetch('/auth/register/verify-otp', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail, otp })
        });
        const data = await res.json();
        
        if (data.valid) {
            currentOtp = otp;
            showStep(3);
            showToast('Xác thực OTP thành công!', 'success');
        } else {
            showToast(data.message || 'Mã OTP không hợp lệ hoặc đã hết hạn!', 'error');
        }
    } catch (e) {
        showToast('Lỗi kết nối', 'error');
    } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
    }
}

function startCountdown() {
    let seconds = 60;
    const link = document.getElementById('resendLink');
    const countdown = document.getElementById('countdown');
    link.classList.add('disabled');
    
    clearInterval(countdownInterval);
    countdownInterval = setInterval(() => {
        seconds--;
        countdown.textContent = seconds;
        if (seconds <= 0) {
            clearInterval(countdownInterval);
            link.classList.remove('disabled');
            link.innerHTML = 'Gửi lại mã';
        }
    }, 1000);
}

async function resendOtp() {
    if (document.getElementById('resendLink').classList.contains('disabled')) return;
    await sendOtp();
}

function togglePassword(id) {
    const input = document.getElementById(id);
    const eye = document.getElementById(id + '-eye');
    if (input.type === 'password') {
        input.type = 'text';
        eye.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
    } else {
        input.type = 'password';
        eye.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
    }
}

function checkStrength() {
    const pw = document.getElementById('password').value;
    const section = document.getElementById('strengthSection');
    if (!pw) { section.style.display = 'none'; return; }
    section.style.display = 'block';
    
    const checks = {
        len: pw.length >= 8,
        upper: /[A-Z]/.test(pw),
        lower: /[a-z]/.test(pw),
        num: /[0-9]/.test(pw),
        spec: /[!@#$%^&*(),.?":{}|<>]/.test(pw)
    };
    
    ['Len','Upper','Lower','Num','Spec'].forEach(k => {
        const el = document.getElementById('req' + k);
        const met = checks[k.toLowerCase()];
        el.className = met ? 'met' : '';
        el.innerHTML = (met ? '✓' : '✗') + el.innerHTML.substring(1);
    });
    
    const strength = Object.values(checks).filter(Boolean).length;
    const colors = ['#ed4956','#fd8d32','#feda75','#00d26a'];
    const texts = ['Yếu','Trung bình','Khá','Mạnh'];
    
    [1,2,3,4].forEach(i => {
        document.getElementById('bar' + i).style.background = i <= strength ? colors[strength-1] : '#363636';
    });
    
    const textEl = document.getElementById('strengthText');
    textEl.textContent = strength > 0 ? 'Độ mạnh: ' + texts[strength-1] : '';
    textEl.style.color = colors[strength-1] || '#a8a8a8';
}

async function completeRegistration() {
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const username = document.getElementById('username').value.trim();
    
    if (password.length < 8) {
        showToast('Mật khẩu phải có ít nhất 8 ký tự!', 'error');
        return;
    }
    if (!/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/[0-9]/.test(password)) {
        showToast('Mật khẩu phải có chữ hoa, chữ thường và số!', 'error');
        return;
    }
    if (password !== confirmPassword) {
        showToast('Mật khẩu xác nhận không khớp!', 'error');
        return;
    }
    
    const btn = document.getElementById('registerBtn');
    btn.disabled = true;
    btn.classList.add('loading');
    
    try {
        const res = await fetch('/auth/register/complete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: currentEmail, otp: currentOtp, password, username })
        });
        const data = await res.json();
        
        if (res.ok && (data.status === 'success' || data.success)) {
            showToast('Đăng ký tài khoản thành công!', 'success');
            setTimeout(() => {
                window.location.href = '/login?message=' + encodeURIComponent('Đăng ký thành công! Vui lòng đăng nhập.');
            }, 1500);
        } else {
            showToast(data.message || 'Đăng ký thất bại!', 'error');
        }
    } catch (e) {
        showToast('Lỗi kết nối! Vui lòng thử lại.', 'error');
    } finally {
        btn.disabled = false;
        btn.classList.remove('loading');
    }
}

function showToast(message, type = 'info') {
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }
    const icons = {
        success: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm13.36-1.814a.75.75 0 10-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 00-1.06 1.06l2.25 2.25a.75.75 0 001.14-.094l3.75-5.25z" clip-rule="evenodd" /></svg>',
        error: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25zm-1.72 6.97a.75.75 0 10-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 101.06 1.06L12 13.06l1.72 1.72a.75.75 0 101.06-1.06L13.06 12l1.72-1.72a.75.75 0 10-1.06-1.06L12 10.94l-1.72-1.72z" clip-rule="evenodd" /></svg>',
        info: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12zm8.706-1.442c1.146-.573 2.437.463 2.126 1.706l-.709 2.836.042-.02a.75.75 0 01.67 1.34l-.04.022c-1.147.573-2.438-.463-2.127-1.706l.71-2.836-.042.02a.75.75 0 11-.671-1.34l.041-.022zM12 9a.75.75 0 100-1.5.75.75 0 000 1.5z" clip-rule="evenodd" /></svg>'
    };
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `<span style="color: ${type === 'success' ? '#00d26a' : type === 'error' ? '#ed4956' : '#0095f6'}">${icons[type] || icons.info}</span><span>${message}</span><button class="toast-close" onclick="this.parentElement.remove()">×</button>`;
    container.appendChild(toast);
    setTimeout(() => toast.classList.add('show'), 50);
    setTimeout(() => toast.remove(), 4000);
}
</script>
</body>
</html>
